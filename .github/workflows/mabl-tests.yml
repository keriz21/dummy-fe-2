name: Run mabl Tests

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    workflow_dispatch:

jobs:
    mabl-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Notify Slack - Testing Started
              uses: slackapi/slack-github-action@v1.26.0
              with:
                  payload: |
                      {
                          "text": "üß™ Testing Started - ${{ github.repository }}",
                          "blocks": [
                              {
                                  "type": "header",
                                  "text": {
                                      "type": "plain_text",
                                      "text": "üß™ Testing Started"
                                  }
                              },
                              {
                                  "type": "section",
                                  "text": {
                                      "type": "mrkdwn",
                                      "text": "GitHub Actions is running mabl tests for *${{ github.repository }}*"
                                  }
                              },
                              {
                                  "type": "section",
                                  "fields": [
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Branch:*\n${{ github.ref_name }}"
                                      },
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Triggered by:*\n${{ github.actor }}"
                                      }
                                  ]
                              }
                          ]
                      }
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

            - name: Run mabl deployment tests
              id: mabl
              uses: mablhq/github-run-tests-action@v1
              env:
                  MABL_API_KEY: ${{ secrets.MABL_API_KEY }}
              with:
                  application-id: ${{ secrets.MABL_APP_ID }}
                  environment-id: ${{ secrets.MABL_ENV_ID }}

            - name: Post test results
              if: always()
              run: |
                  echo "mabl tests completed"
                  echo "Check mabl dashboard for detailed results"

            - name: Notify Slack on Success
              if: success()
              uses: slackapi/slack-github-action@v1.26.0
              with:
                  payload: |
                      {
                          "text": "‚úÖ ${{ github.repository }} - mabl Tests PASSED",
                          "blocks": [
                              {
                                  "type": "header",
                                  "text": {
                                      "type": "plain_text",
                                      "text": "‚úÖ Tests Passed"
                                  }
                              },
                              {
                                  "type": "section",
                                  "text": {
                                      "type": "mrkdwn",
                                      "text": "*${{ github.repository }}* successfully passed all mabl tests! üéâ"
                                  }
                              },
                              {
                                  "type": "section",
                                  "fields": [
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Repository:*\n${{ github.repository }}"
                                      },
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Branch:*\n${{ github.ref_name }}"
                                      },
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Commit:*\n${{ github.sha }}"
                                      },
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Author:*\n${{ github.actor }}"
                                      }
                                  ]
                              },
                              {
                                  "type": "actions",
                                  "elements": [
                                      {
                                          "type": "button",
                                          "text": {
                                              "type": "plain_text",
                                              "text": "View Run"
                                          },
                                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                                      }
                                  ]
                              }
                          ]
                      }
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

            - name: Notify Slack on Failure
              if: failure()
              uses: slackapi/slack-github-action@v1.26.0
              with:
                  payload: |
                      {
                          "text": "‚ùå ${{ github.repository }} - mabl Tests FAILED",
                          "blocks": [
                              {
                                  "type": "header",
                                  "text": {
                                      "type": "plain_text",
                                      "text": "‚ùå Tests Failed"
                                  }
                              },
                              {
                                  "type": "section",
                                  "text": {
                                      "type": "mrkdwn",
                                      "text": "‚ö†Ô∏è *${{ github.repository }}* failed mabl tests. Please review the errors."
                                  }
                              },
                              {
                                  "type": "section",
                                  "fields": [
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Repository:*\n${{ github.repository }}"
                                      },
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Branch:*\n${{ github.ref_name }}"
                                      },
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Commit:*\n${{ github.sha }}"
                                      },
                                      {
                                          "type": "mrkdwn",
                                          "text": "*Author:*\n${{ github.actor }}"
                                      }
                                  ]
                              },
                              {
                                  "type": "actions",
                                  "elements": [
                                      {
                                          "type": "button",
                                          "text": {
                                              "type": "plain_text",
                                              "text": "View Failed Run"
                                          },
                                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                                          "style": "danger"
                                      }
                                  ]
                              }
                          ]
                      }
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    # deploy-production:
    #     needs: mabl-test
    #     runs-on: ubuntu-latest
    #     if: success() && github.ref == 'refs/heads/main'

    #     steps:
    #         - name: Checkout code
    #           uses: actions/checkout@v4

    #         - name: Deploy to Production
    #           run: |
    #               echo "üöÄ Deploying to production..."
    #               echo "All tests passed, deploying now!"
    #               # Tambahkan script deploy Anda di sini
    #               # Contoh: npm run deploy, rsync, aws s3 sync, dll

    #         - name: Notify Slack - Deploy Started
    #           uses: slackapi/slack-github-action@v1.26.0
    #           with:
    #               payload: |
    #                   {
    #                       "text": "üöÄ Deploying to Production...",
    #                       "blocks": [
    #                           {
    #                               "type": "header",
    #                               "text": {
    #                                   "type": "plain_text",
    #                                   "text": "üöÄ Deploying to Production"
    #                               }
    #                           },
    #                           {
    #                               "type": "section",
    #                               "text": {
    #                                   "type": "mrkdwn",
    #                                   "text": "All mabl tests passed! Deploying *${{ github.repository }}* to production."
    #                               }
    #                           }
    #                       ]
    #                   }
    #           env:
    #               SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    #         - name: Notify Slack - Deploy Success
    #           if: success()
    #           uses: slackapi/slack-github-action@v1.26.0
    #           with:
    #               payload: |
    #                   {
    #                       "text": "‚úÖ Production Deployment SUCCESS",
    #                       "blocks": [
    #                           {
    #                               "type": "header",
    #                               "text": {
    #                                   "type": "plain_text",
    #                                   "text": "‚úÖ Deployed to Production"
    #                               }
    #                           },
    #                           {
    #                               "type": "section",
    #                               "fields": [
    #                                   {
    #                                       "type": "mrkdwn",
    #                                       "text": "*Environment:*\nProduction"
    #                                   },
    #                                   {
    #                                       "type": "mrkdwn",
    #                                       "text": "*Branch:*\n${{ github.ref_name }}"
    #                                   },
    #                                   {
    #                                       "type": "mrkdwn",
    #                                       "text": "*Deployed by:*\n${{ github.actor }}"
    #                                   },
    #                                   {
    #                                       "type": "mrkdwn",
    #                                       "text": "*Status:*\n‚úÖ Live"
    #                                   }
    #                               ]
    #                           }
    #                       ]
    #                   }
    #           env:
    #               SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    #         - name: Notify Slack - Deploy Failed
    #           if: failure()
    #           uses: slackapi/slack-github-action@v1.26.0
    #           with:
    #               payload: |
    #                   {
    #                       "text": "‚ùå Production Deployment FAILED",
    #                       "blocks": [
    #                           {
    #                               "type": "header",
    #                               "text": {
    #                                   "type": "plain_text",
    #                                   "text": "‚ùå Deployment Failed"
    #                               }
    #                           },
    #                           {
    #                               "type": "section",
    #                               "text": {
    #                                   "type": "mrkdwn",
    #                                   "text": "‚ö†Ô∏è Production deployment failed for *${{ github.repository }}*"
    #                               }
    #                           },
    #                           {
    #                               "type": "actions",
    #                               "elements": [
    #                                   {
    #                                       "type": "button",
    #                                       "text": {
    #                                           "type": "plain_text",
    #                                           "text": "View Logs"
    #                                       },
    #                                       "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
    #                                       "style": "danger"
    #                                   }
    #                               ]
    #                           }
    #                       ]
    #                   }
    #           env:
    #               SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
